<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<title>LW STUDY HALL</title>
		<meta name="language" content="en" />
		<meta name="description" content="This chat is for co-working - we invite everyone who wants to be productive." />
 		<meta name="keywords" content="wtfs, wtfs chitchat, wtfs.de, co-working, video chat, video conference, screensharing, opensource, webrtc, erlang" />
		<meta name="title" content="wtfs - LW STUDY HALL" />
		<meta name="author" content="Mr. Pi <mrpi@mr-pi.de>" />
		<meta name="publisher" content="Mr. Pi" />
		<meta name="copyright" content="Mr. Pi, 2014" />
		<meta name="abstract" content="This chat is for co-working - we invite everyone who wants to be productive." />
		<meta name="page-topic" content="web service" />
		<meta name="page-type" content="web service" />
		<meta name="audience" content="students, managers, supervisors, developer" />
		<meta name="revisit" content="10 days" />
		<meta name="revisit-after" content="10 days" />
		<meta name="robots" content="index, follows" />
		<link rel="stylesheet" type="text/css" href="./css/button.css" />
		<link rel="stylesheet" type="text/css" href="./css/browser.css" />
		<link rel="stylesheet" type="text/css" href="./css/main.css" />
	</head>
	<body>
		<header>
			<h1><a href="http://lesswrong.com/" target="_new">LW</a> STUDY HALL</h1>
			<span><b>Welcome!</b> This chat is for co-working - we invite everyone who wants to be productive.<br />Introduction can be found <a href="https://docs.google.com/document/d/1rN_DJBwfnhSZ_r-9d0zBVrrrSw47ugbtCRaV6__TezA/edit?usp=sharing">here</a></span>
		</header>
		</section>
		<section>
			<article>
				<button id="btn_broadcastvideo" class="small" onclick="start_streaming('video');">broadcast video</button>
				<button id="btn_broadcastscreen" class="small chrome_only https_only" onclick="start_streaming('screen');">broadcast screen <b>*</b></button><br />
				<div id="videos">
				</div>
				<fieldset><legend><input type="text" placeholder="Your Name" /></legend>
					<table>
						<tr>
							<td>der</td>
							<td>hi, how are you?</td>
						</tr>
						<tr>
							<td>das</td>
							<td>I'm fine, all in one</td>
						</tr>
					</table>
				</fieldset>
				<aside class="chrome_only https_only"><b>*</b> This feature requires »Enable screen capture support in getUserMedia().« enabled in »chrome://flags/#enable-usermedia-screen-capture«</aside>
			</article>
		</section>
		<script src="./js/media.js"></script>
		<script src="./js/browser.js"></script>
		<script src="./js/signaling.js"></script>
		<script>
			browser.init();
			var capture = new Media({
				onChanged: function(options) {
					console.info("change media source");
					type=(options.video!==true)?"video":"screen";
					document.getElementById('btn_broadcast'+type).innerHTML = "broadcast "+type;
					document.getElementById('btn_broadcast'+type).setAttribute('onclick', 'start_streaming("'+type+'")');
				},
				onEnded: function(options) {
					type=(options.video===true)?"video":"screen";
					console.info("end of capture "+type);
					document.getElementById('btn_broadcast'+type).innerHTML = "broadcast "+type;
					document.getElementById('btn_broadcast'+type).setAttribute('onclick', 'start_streaming("'+type+'")');
					removeVideo("self");
				},
				onError: function(error) {
					console.error("webrtc error: "+error);
					alert("ERROR: " + error);
				},
				onSupported: function() {
					console.info("webrtc is supported");
				},
				onNotSupported: function() {
					console.error("webrtc is not supported");
				}
			});
			var resize = function() {
				var videos = document.getElementsByTagName('video');
				var width = (document.getElementById('videos').offsetWidth-30)/videos.length;
				for(var i=0; i<videos.length; i++) { videos[i].width=width; }
			};
			var addVideo = function(source, name) {
				if(document.getElementById('vidCon_'+name) != null) {
					document.getElementById('video_'+name).src = source;
				}
				else {
					var old = document.getElementById('videos').innerHTML;
					document.getElementById('videos').innerHTML = old +
						'<div class="vidCon" id="vidCon_'+name+'">'+
						'<span class="vidTitle">'+name+'</span>'+
						'<video muted autoplay poster="./img/nopic.png" id="video_'+name+'" src="'+source+'"></video>'+
						'</div>';
					resize();
				}
			};
			var removeVideo = function(name) {
				if(document.getElementById('vidCon_'+name)!=null) {
					document.getElementById('vidCon_'+name).remove();
				}
				resize();
			};
			var stop_streaming = function(mediaType) {
				capture.stop();
				removeVideo("self");
				document.getElementById('btn_broadcast'+mediaType).innerHTML = "broadcast "+mediaType;
				document.getElementById('btn_broadcast'+mediaType).setAttribute('onclick', 'start_streaming("'+mediaType+'")');
			};
			signaling.init({
				onAddStream: function() {
					alert('stream added');
				}
			});
			var start_streaming = function(mediaType) {
				capture.start({
					handleStream: function(stream, src) {
						document.getElementById('btn_broadcast'+mediaType).innerHTML = "stop streaming "+mediaType;
						document.getElementById('btn_broadcast'+mediaType).setAttribute('onclick', 'stop_streaming("'+mediaType+'")');
						addVideo(src, "self");
					},
					video: mediaType=="video",
					audio: false,
					screen: mediaType=="screen"
				});
			};
		</script>
	</body>
</html>
